---
AWSTemplateFormatVersion: "2010-09-09"
Description: >-
  CloudFormation template for creating a Code Connections RepositoryLink to
  a GitHub repository.

Parameters:

  GitHubOrganisationName:
    Type: AWS::SSM::Parameter::Value<String>
    Description: >-
      The name of the GitHub organisation stored in SSM Parameter Store.
    Default: "/github_organisation"

  GitHubRepositoryName:
    Type: AWS::SSM::Parameter::Value<String>
    Description: >-
      The name of the GitHub repository stored in SSM Parameter Store.
    Default: "/github_repository"

  CodeConnectionArn:
    Type: AWS::SSM::Parameter::Value<String>
    Description: >-
      The ARN of the CodeConnection stored in SSM Parameter Store.
    Default: "/codeconnection_arn"

Resources:

  CodeStarRepositoryLink:
    Type: AWS::CodeStarConnections::RepositoryLink
    Properties:
      OwnerId: !Ref GitHubOrganisationName
      RepositoryName: !Ref GitHubRepositoryName
      ConnectionArn: !Ref CodeConnectionArn

  GitSyncRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: "SvcCatMan-gitsync-role"
      Path: "/service-role/"
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Sid: CfnGitSyncTrustPolicy
            Effect: Allow
            Principal:
              Service: cloudformation.sync.codeconnections.amazonaws.com
            Action: sts:AssumeRole
      Description: "CloudFormation Git sync role"
      MaxSessionDuration: 3600
      Policies:
        - PolicyName: SyncPolicy
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Sid: SyncToCloudFormation
                Effect: Allow
                Action:
                  - "cloudformation:CreateChangeSet"
                  - "cloudformation:DeleteChangeSet"
                  - "cloudformation:DescribeChangeSet"
                  - "cloudformation:DescribeStackEvents"
                  - "cloudformation:DescribeStacks"
                  - "cloudformation:ExecuteChangeSet"
                  - "cloudformation:GetTemplate"
                  - "cloudformation:ListChangeSets"
                  - "cloudformation:ListStacks"
                  - "cloudformation:ValidateTemplate"
                Resource:
                  # [TODO: replace with SSM param output of stack ARN]
                  - !Sub "arn:aws:cloudformation:${AWS::Region}:${AWS::AccountId}:stack/SvcCatMan-management-pipeline" # yamllint disable-line rule:line-length
                  - !Sub "arn:aws:cloudformation:e${AWS::Region}:${AWS::AccountId}:stack/SvcCatMan-management-pipeline/*" # yamllint disable-line rule:line-length
              - Sid: PolicyForManagedRules
                Effect: Allow
                Action:
                  - "events:PutRule"
                  - "events:PutTargets"
                Resource: "*"
                Condition:
                  StringEquals:
                    events:ManagedBy:
                      - "cloudformation.sync.codeconnections.amazonaws.com"
              - Sid: PolicyForDescribingRule
                Effect: Allow
                Action: "events:DescribeRule"
                Resource: "*"

Outputs:

  RepositoryLinkId:
    Description: "The ID of the RepositoryLink."
    Value: !Ref CodeStarRepositoryLink
